{% extends "accounts/base_cliente.html" %}

{% block title %}Mis servicios · Hotel Elegance{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="h4 mb-1">Mis servicios</h1>
    <p class="text-muted mb-0">
      Aquí ves todos los servicios que has solicitado durante tus reservas.
    </p>
  </div>
  <div>
    <a href="{% url 'servicios:cliente_nuevo' %}" class="btn btn-primary btn-sm">
      Solicitar servicio
    </a>
  </div>
</div>

<div class="card shadow-sm mb-3">
  <div class="card-body">
    <form method="get" class="row g-2 align-items-end">
      <div class="col-md-4">
        <label class="form-label small text-muted">Estado</label>
        <select name="estado" class="form-select">
          <option value="">Todos</option>
          {% for value, label in estados %}
            <option value="{{ value }}" {% if filtros.estado == value %}selected{% endif %}>
              {{ label }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label small text-muted">Categoría</label>
        <select name="categoria" class="form-select">
          <option value="">Todas</option>
          {% for value, label in categorias %}
            <option value="{{ value }}" {% if filtros.categoria == value %}selected{% endif %}>
              {{ label }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4 d-flex gap-2">
        <button type="submit" class="btn btn-outline-primary btn-sm mt-3">
          Filtrar
        </button>
        <a href="{% url 'servicios:cliente_mis_servicios' %}" class="btn btn-outline-secondary btn-sm mt-3">
          Limpiar
        </a>
      </div>
    </form>

    <hr class="my-3">

    <div class="row g-3">
      <div class="col-md-4">
        <div class="text-muted small text-uppercase mb-1">Total consumos</div>
        <div class="fw-semibold">
          ${{ totales.total_monto }}
        </div>
      </div>
      <div class="col-md-4">
        <div class="text-muted small text-uppercase mb-1">Total pagado</div>
        <div class="fw-semibold">
          ${{ totales.total_pagado }}
        </div>
      </div>
      <div class="col-md-4">
        <div class="text-muted small text-uppercase mb-1">Saldo pendiente aprox.</div>
        <div class="fw-semibold">
          ${{ totales.total_monto|default:0|add:"-0"|floatformat:0|default:0 }}
        </div>
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body p-0">
    {% if consumos %}
      <div class="table-responsive">
        <table class="table table-hover mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th>Servicio</th>
              <th>Reserva</th>
              <th>Fecha</th>
              <th>Cantidad</th>
              <th>Estado</th>
              <th class="text-end">Total</th>
              <th class="text-end">Pendiente</th>
              <th class="text-end">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for c in consumos %}
              <tr>
                <td>
                  {{ c.servicio.nombre }}
                  <br>
                  <small class="text-muted">
                    {{ c.servicio.get_categoria_display }}
                  </small>
                </td>
                <td>
                  {{ c.reserva.code }}
                  <br>
                  <small class="text-muted">
                    Hab {{ c.reserva.room.codigo }}
                  </small>
                </td>
                <td>
                  {{ c.creado_en|date:"Y-m-d H:i" }}
                </td>
                <td>{{ c.cantidad }}</td>
                <td>
                  {% if c.estado == 'PENDIENTE' %}
                    <span class="badge bg-warning text-dark">{{ c.get_estado_display }}</span>
                  {% elif c.estado == 'APROBADO' %}
                    <span class="badge bg-info text-dark">{{ c.get_estado_display }}</span>
                  {% elif c.estado == 'FACTURADO' %}
                    <span class="badge bg-success">{{ c.get_estado_display }}</span>
                  {% elif c.estado == 'CANCELADO' %}
                    <span class="badge bg-secondary">{{ c.get_estado_display }}</span>
                  {% else %}
                    <span class="badge bg-light text-dark">{{ c.get_estado_display }}</span>
                  {% endif %}
                </td>
                <td class="text-end">
                  ${{ c.total }}
                </td>
                <td class="text-end">
                  {% if c.saldo_pendiente > 0 %}
                    <span class="text-danger">${{ c.saldo_pendiente }}</span>
                  {% else %}
                    <span class="text-success">Pagado</span>
                  {% endif %}
                </td>
                <td class="text-end">
                  <a href="{% url 'servicios:cliente_detalle' c.pk %}"
                     class="btn btn-outline-secondary btn-sm me-1">
                    Ver
                  </a>

                  {% if c.saldo_pendiente > 0 and c.estado != 'CANCELADO' %}
                    <a href="{% url 'servicios:cliente_pago' c.pk %}"
                       class="btn btn-success btn-sm me-1">
                      Pagar
                    </a>
                  {% endif %}

                  {% if c.estado == 'PENDIENTE' or c.estado == 'APROBADO' %}
                    <form action="{% url 'servicios:cliente_cancelar' c.pk %}"
                          method="post" class="d-inline">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-outline-danger btn-sm"
                              onclick="return confirm('¿Seguro que deseas cancelar este servicio?');">
                        Cancelar
                      </button>
                    </form>
                  {% elif c.saldo_pendiente <= 0 %}
                    <button class="btn btn-outline-secondary btn-sm" disabled>
                      Sin acciones
                    </button>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="p-3 mb-0 text-muted">
        Aún no tienes servicios registrados.
      </p>
    {% endif %}
  </div>
</div>

{% endblock %}
