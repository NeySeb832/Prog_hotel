{% extends "accounts/base_cliente.html" %} {# Cambia esto si usas otra base, por ejemplo "layout_cliente.html" #}

{% block title %}Mi panel · Hotel Elegance{% endblock %}

{% block content %}
<div class="container py-4">
  <!-- Encabezado -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h3 mb-1">
        Hola, {{ request.user.first_name|default:request.user.username }}
      </h1>
      <p class="text-muted mb-0">
        Este es tu panel personal. Aquí puedes ver tus reservas, tu estancia actual y los servicios que has solicitado.
      </p>
    </div>
    <div class="text-end">
      <a href="{{ urls.mis_reservas_nueva }}" class="btn btn-primary btn-sm">
        Nueva reserva
      </a>
      <a href="{{ urls.logout }}" class="btn btn-outline-secondary btn-sm">
        Cerrar sesión
      </a>
    </div>
  </div>

  <!-- KPIs principales -->
  <div class="row g-3 mb-4">
    <div class="col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <p class="text-muted text-uppercase small mb-1">Reservas registradas</p>
          <h2 class="h3 mb-0">{{ reservas_total }}</h2>
          <small class="text-muted">Incluye activas, futuras e históricas.</small>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <p class="text-muted text-uppercase small mb-1">Noches totales reservadas</p>
          <h2 class="h3 mb-0">{{ noches_totales }}</h2>
          <small class="text-muted">Sumando todas tus reservas.</small>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <p class="text-muted text-uppercase small mb-1">Saldo pendiente aprox.</p>
          <h2 class="h3 mb-0">
            ${{ saldo_pendiente }}
          </h2>
          <small class="text-muted">Entre reservas y servicios registrados.</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Estancia actual / próxima + servicios recientes -->
  <div class="row g-3 mb-4">
    <!-- Estancia actual -->
    <div class="col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span class="fw-semibold">Tu estancia actual / próxima</span>
          <a href="{{ urls.mis_reservas }}" class="small">Ver todas</a>
        </div>
        <div class="card-body">
          {% if estancia_actual %}
            <h5 class="card-title mb-1">
              Habitación {{ estancia_actual.room.codigo }}
              {% if estancia_actual.room.tipo %}
                · {{ estancia_actual.room.tipo.nombre }}
              {% endif %}
            </h5>
            <p class="mb-1">
              Entrada: <strong>{{ estancia_actual.check_in }}</strong><br>
              Salida: <strong>{{ estancia_actual.check_out }}</strong><br>
              Noches: <strong>{{ estancia_actual.nights }}</strong>
            </p>
            <p class="mb-2">
              Estado:
              <span class="badge bg-primary">
                {{ estancia_actual.get_status_display }}
              </span>
            </p>
            <p class="mb-0 small text-muted">
              Importe aprox.: ${{ estancia_actual.total_amount }}
              · Pagado: ${{ estancia_actual.paid_amount }}
              · Pendiente: ${{ estancia_actual.pending_amount }}
            </p>
          {% else %}
            <p class="mb-0 text-muted">
              No tienes una estancia activa o próxima en este momento.
            </p>
            <a href="{{ urls.mis_reservas_nueva }}" class="btn btn-sm btn-primary mt-2">
              Hacer una nueva reserva
            </a>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Servicios recientes -->
    <div class="col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span class="fw-semibold">Últimos servicios registrados</span>
          <a href="{{ urls.otros_servicios }}" class="small">Ver más</a>
        </div>
        <div class="card-body">
          {% if solicitudes_servicio %}
            <ul class="list-group list-group-flush">
              {% for consumo in solicitudes_servicio %}
                <li class="list-group-item px-0">
                  <div class="d-flex justify-content-between">
                    <div>
                      <div class="fw-semibold">
                        {{ consumo.servicio.nombre }}
                      </div>
                      <small class="text-muted">
                        Reserva {{ consumo.reserva.code }}
                        · Hab {{ consumo.reserva.room.codigo }}<br>
                        Cantidad: {{ consumo.cantidad }} · Total: ${{ consumo.total }}
                      </small>
                    </div>
                    <div class="text-end">
                      <span class="badge
                        {% if consumo.estado == 'PENDIENTE' %}bg-warning text-dark
                        {% elif consumo.estado == 'APROBADO' %}bg-info text-dark
                        {% elif consumo.estado == 'FACTURADO' %}bg-success
                        {% elif consumo.estado == 'CANCELADO' %}bg-secondary
                        {% else %}bg-light text-dark
                        {% endif %}
                      ">
                        {{ consumo.get_estado_display }}
                      </span>
                    </div>
                  </div>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="mb-0 text-muted">
              Aún no tienes servicios registrados asociados a tus reservas.
            </p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Reservas recientes -->
  <div class="card shadow-sm mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span class="fw-semibold">Tus reservas recientes</span>
      <a href="{{ urls.mis_reservas }}" class="small">Ver historial completo</a>
    </div>
    <div class="card-body p-0">
      {% if reservas %}
        <div class="table-responsive">
          <table class="table table-hover mb-0 align-middle">
            <thead>
              <tr>
                <th>Código</th>
                <th>Habitación</th>
                <th>Entrada</th>
                <th>Salida</th>
                <th>Noches</th>
                <th>Estado</th>
                <th>Total</th>
                <th>Pendiente</th>
              </tr>
            </thead>
            <tbody>
              {% for r in reservas %}
                <tr>
                  <td>{{ r.code }}</td>
                  <td>
                    {{ r.room.codigo }}
                    {% if r.room.tipo %}
                      <br><small class="text-muted">{{ r.room.tipo.nombre }}</small>
                    {% endif %}
                  </td>
                  <td>{{ r.check_in }}</td>
                  <td>{{ r.check_out }}</td>
                  <td>{{ r.nights }}</td>
                  <td>
                    <span class="badge bg-secondary">
                      {{ r.get_status_display }}
                    </span>
                  </td>
                  <td>${{ r.total_amount }}</td>
                  <td>
                    {% if r.pending_amount > 0 %}
                      <span class="text-danger">${{ r.pending_amount }}</span>
                    {% else %}
                      <span class="text-success">Pagado</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="p-3 mb-0 text-muted">
          Todavía no tienes reservas registradas.
        </p>
      {% endif %}
    </div>
  </div>

  <!-- Accesos rápidos -->
  <div class="d-flex flex-wrap gap-2">
    <a href="{{ urls.mis_reservas }}" class="btn btn-outline-primary btn-sm">
      Ver todas mis reservas
    </a>
    <a href="{{ urls.room_service }}" class="btn btn-outline-primary btn-sm">
      Room service
    </a>
    <a href="{{ urls.otros_servicios }}" class="btn btn-outline-primary btn-sm">
      Otros servicios
    </a>
  </div>
</div>
{% endblock %}
