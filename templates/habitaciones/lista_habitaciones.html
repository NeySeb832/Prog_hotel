{% extends "admin_hotel/base_admin.html" %}
{% load static %}

{% block title %}Habitaciones · HotelManager{% endblock %}

{% block extra_head %}
<style>
  .room-card {
    border-radius: .75rem;
    border: 1px solid rgba(0,0,0,.05);
    background: #ffffff;
    box-shadow: 0 2px 6px rgba(15,23,42,0.06);
    padding: 1rem;
    height: 100%;
    display: flex;
    flex-direction: column;
    gap: .5rem;
  }

  .room-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: .75rem;
  }

  .room-code {
    font-weight: 700;
    font-size: 1.05rem;
  }

  .room-type {
    font-size: .8rem;
    color: #6b7280;
  }

  .chip {
    display: inline-flex;
    align-items: center;
    gap: .35rem;
    border-radius: 999px;
    padding: .15rem .6rem;
    font-size: .75rem;
    font-weight: 500;
  }

  .chip.green {
    background: #dcfce7;
    color: #166534;
  }

  .chip.blue {
    background: #dbeafe;
    color: #1d4ed8;
  }

  .chip.yellow {
    background: #fef9c3;
    color: #854d0e;
  }

  .chip.gray {
    background: #e5e7eb;
    color: #374151;
  }

  .room-card--LIBRE {
    background: #ecfdf5;
    border-color: #bbf7d0;
  }
  .room-card--OCUPADA {
    background: #eff6ff;
    border-color: #bfdbfe;
  }
  .room-card--RESERVADA {
    background: #fef9c3;
    border-color: #fde68a;
  }
  .room-card--MANTENIMIENTO {
    background: #f9fafb;
    border-color: #e5e7eb;
  }

  .status-banner {
    border-radius: .75rem;
    padding: .35rem .7rem;
    font-size: .8rem;
    font-weight: 600;
    margin-bottom: .25rem;
    background: rgba(255,255,255,.75);
  }

  .status-libre {
    color: #16a34a;
  }

  .status-ocupada {
    color: #1d4ed8;
  }

  .status-reservada {
    color: #854d0e;
  }

  .status-fuera {
    color: #6b7280;
  }

  .muted { color: #6b7280; }
</style>
{% endblock %}

{% block page_title %}Habitaciones{% endblock %}
{% block page_subtitle %}Gestión de habitaciones y reservas asociadas{% endblock %}

{% block content %}

{# Barra superior: filtros + botón Nueva Habitación #}
<div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3 gap-2">
  <form method="get" class="flex-grow-1">
    <div class="row g-2">
      <div class="col-md-3">
        <div class="input-group">
          <span class="input-group-text bg-white border-end-0">
            <i class="bi bi-search"></i>
          </span>
          <input type="text"
                 class="form-control border-start-0"
                 name="q"
                 placeholder="Buscar por código o tipo..."
                 value="{{ filtros.q }}">
        </div>
      </div>

      <div class="col-md-2">
        <select class="form-select" name="piso" onchange="this.form.submit()">
          <option value="">Todos los pisos</option>
          {% for p in pisos %}
            <option value="{{ p }}" {% if filtros.piso == p|stringformat:"s" %}selected{% endif %}>
              Piso {{ p }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-3">
        <select class="form-select" name="tipo" onchange="this.form.submit()">
          <option value="">Todos los tipos</option>
          {% for t in tipos %}
            <option value="{{ t.id }}" {% if filtros.tipo == t.id|stringformat:"s" %}selected{% endif %}>
              {{ t.nombre }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-4">
        <select class="form-select" name="estado" onchange="this.form.submit()">
          <option value="">Todos los estados</option>
          {% for value, label in estado_choices %}
            <option value="{{ value }}" {% if filtros.estado == value %}selected{% endif %}>
              {{ label }}
            </option>
          {% endfor %}
        </select>
      </div>
    </div>
  </form>

  <div class="text-md-end mt-2 mt-md-0">
    <button class="btn btn-dark" type="button" data-bs-toggle="modal" data-bs-target="#modalNuevaHabitacion">
      <i class="bi bi-plus-lg"></i> Nueva Habitación
    </button>
  </div>
</div>

{# KPIs simples #}
<div class="row g-2 mb-3">
  <div class="col-6 col-md-3">
    <div class="p-2 border rounded-3 bg-white">
      <div class="small muted">Total habitaciones</div>
      <div class="fw-semibold fs-5">{{ kpis.total }}</div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="p-2 border rounded-3 bg-white">
      <div class="small muted">Libres</div>
      <div class="fw-semibold fs-5 text-success">{{ kpis.libres }}</div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="p-2 border rounded-3 bg-white">
      <div class="small muted">Ocupadas</div>
      <div class="fw-semibold fs-5 text-primary">{{ kpis.ocupadas }}</div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="p-2 border rounded-3 bg-white">
      <div class="small muted">Reservadas</div>
      <div class="fw-semibold fs-5 text-warning">{{ kpis.reservadas }}</div>
    </div>
  </div>
</div>

{# Grid de habitaciones #}
<div class="row g-3">
  {% for r in rooms %}
    <div class="col-12 col-md-6 col-lg-4">
      <div class="room-card
        {% if r.current_reservation %}
          room-card--OCUPADA
        {% elif r.next_reservation %}
          room-card--RESERVADA
        {% else %}
          room-card--{{ r.estado }}
        {% endif %}
      ">

        {# Banner de estado #}
        <div class="status-banner
          {% if r.current_reservation %}
            status-ocupada
          {% elif r.next_reservation %}
            status-reservada
          {% elif r.estado == 'LIBRE' %}
            status-libre
          {% elif r.estado == 'OCUPADA' %}
            status-ocupada
          {% elif r.estado == 'RESERVADA' %}
            status-reservada
          {% else %}
            status-fuera
          {% endif %}
        ">
          {% if r.current_reservation %}
            Habitación ocupada
          {% elif r.next_reservation %}
            Habitación reservada
          {% elif r.estado == 'LIBRE' %}
            Habitación libre
          {% elif r.estado == 'OCUPADA' %}
            Habitación ocupada
          {% elif r.estado == 'RESERVADA' %}
            Habitación reservada
          {% else %}
            Fuera de servicio
          {% endif %}
        </div>

        <div class="room-header">
          <div>
            <div class="room-code">Hab. {{ r.codigo }}</div>
            <div class="room-type">
              Piso {{ r.piso }}
              {% if r.tipo %}
                · {{ r.tipo.nombre }}
              {% endif %}
            </div>
          </div>
          <div class="text-end">
            {% if r.tipo %}
              <div class="fw-semibold">
                $ {{ r.tipo.precio_base|floatformat:0 }} / noche
              </div>
              <div class="small muted">
                Capacidad: {{ r.capacidad }} · Camas: {{ r.camas }}
              </div>
            {% endif %}
          </div>
        </div>

        <hr class="my-2">

        {# Información de reservas asociadas #}
        <div class="small">
          {% if r.current_reservation %}
            <div class="small fw-semibold">
              Estancia en curso
            </div>
            <div class="small">
              Huésped: {{ r.current_reservation.guest_name }}
            </div>
            <div class="small muted">
              {{ r.current_reservation.check_in }} → {{ r.current_reservation.check_out }}
              ({{ r.current_reservation.nights }} noche{% if r.current_reservation.nights != 1 %}s{% endif %})
            </div>
            <div class="small mt-1">
              {% if r.current_reservation.paid_amount == 0 %}
                <span class="chip yellow">Pago pendiente</span>
              {% elif r.current_reservation.paid_amount >= r.current_reservation.total_amount %}
                <span class="chip green">Pagado</span>
              {% else %}
                <span class="chip blue">Pago parcial</span>
              {% endif %}
              <span class="muted small ms-1">
                Total: ${{ r.current_reservation.total_amount }} · Pagado: ${{ r.current_reservation.paid_amount }}
              </span>
            </div>
          {% elif r.next_reservation %}
            <div class="small fw-semibold">
              Próxima reserva:
            </div>
            <div class="small">
              {{ r.next_reservation.check_in }} · huésped {{ r.next_reservation.guest_name }}
            </div>
            <div class="small muted">
              Estancia: {{ r.next_reservation.check_in }} → {{ r.next_reservation.check_out }}
            </div>
          {% else %}
            <div class="small muted">
              Sin reservas asociadas.
            </div>
          {% endif %}
        </div>

        <div class="mt-2 d-flex justify-content-between align-items-center">
          <div>
            <a href="{% url 'reservas:lista' %}?room={{ r.id }}" class="btn btn-outline-primary btn-sm">
              <i class="bi bi-calendar-event"></i> Ver reservas
            </a>
          </div>

          <div class="d-flex gap-1">
            {# ÚNICO cambio permitido aquí: LIBRE <-> MANTENIMIENTO #}
            {% if r.estado == 'MANTENIMIENTO' %}
              <form method="post" action="{% url 'habitaciones:api_toggle' r.pk %}">
                {% csrf_token %}
                <input type="hidden" name="to" value="LIBRE">
                <button class="btn btn-outline-success btn-sm" type="submit">
                  Volver a servicio
                </button>
              </form>
            {% else %}
              <form method="post" action="{% url 'habitaciones:api_toggle' r.pk %}">
                {% csrf_token %}
                <input type="hidden" name="to" value="MANTENIMIENTO">
                <button class="btn btn-outline-warning btn-sm" type="submit"
                        {% if r.current_reservation or r.next_reservation or r.estado == 'OCUPADA' or r.estado == 'RESERVADA' %}disabled{% endif %}>
                  Mantenimiento
                </button>
              </form>
            {% endif %}
          </div>
        </div>

      </div>
    </div>
  {% empty %}
    <div class="col-12">
      <div class="alert alert-warning mb-0">
        No hay habitaciones registradas.
      </div>
    </div>
  {% endfor %}
</div>

{# Modal para crear nueva habitación #}
<div class="modal fade" id="modalNuevaHabitacion" tabindex="-1" aria-labelledby="modalNuevaHabitacionLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content"
          method="post"
          action="{% url 'habitaciones:api_crear' %}">
      {% csrf_token %}
      <div class="modal-header">
        <h5 class="modal-title">Nueva habitación</h5>
        <button class="btn-close" data-bs-dismiss="modal" type="button" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div class="row g-2">
          <div class="col-6">
            <label class="form-label">Código / Número</label>
            <input type="text" name="codigo" class="form-control" required>
          </div>
          <div class="col-6">
            <label class="form-label">Piso</label>
            <input type="number" name="piso" class="form-control" required>
          </div>
        </div>

        <div class="mt-2">
          <label class="form-label">Tipo de habitación</label>
          <select name="tipo_id" class="form-select" required>
            <option value="">Seleccione tipo…</option>
            {% for t in tipos %}
              <option value="{{ t.id }}">{{ t.nombre }}</option>
            {% endfor %}
          </select>
          <small class="text-muted">
            Capacidad, camas y tarifa se toman del tipo de habitación.
          </small>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-dark" type="submit">Guardar</button>
      </div>
    </form>
  </div>
</div>

{% endblock %}
